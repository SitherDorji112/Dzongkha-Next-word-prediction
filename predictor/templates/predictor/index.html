{% load static %}
<!DOCTYPE html>
<html lang="dz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dzongkha Next Word Predictor</title>
    <link rel="stylesheet" href="{% static 'predictor/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .about-icon {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1000;
        }

        .about-icon a {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 153, 51, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .about-icon a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
            background: linear-gradient(135deg, #FF6B35, #FF9933);
            color: white;
            text-decoration: none;
        }

        .home-icon i {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="about-icon">
        <a href="{% url 'about' %}" title="About Our Team">
            <i class="fas fa-users"></i> About Us
        </a>
    </div>
    <div class="container">
        <div class="header">
            <h1>üáßüáπ Dzongkha Next Word Predictor</h1>
            <p>Enter Dzongkha text to get intelligent next word suggestions powered by NLP</p>
        </div>
        
        <div class="input-section">
            <textarea id="inputText" class="input-text" rows="5" placeholder="(Type Dzongkha text here...)"></textarea>
            <small class="input-hint">üí° Press Space to automatically add Tshag (‡ºã) marker</small>
        </div>
        
        <div class="suggestions-section">
            <h3 class="suggestions-title">Suggested Next Words:</h3>
            <div id="suggestions" class="suggestions"></div>
            <div id="loading" class="loading" style="display: none;">
                <span class="spinner"></span> Loading suggestions...
            </div>
        </div>
    </div>

    <script>
    const inputBox = document.getElementById('inputText');
    const suggestionsDiv = document.getElementById('suggestions');
    const loadingDiv = document.getElementById('loading');

    // Automatic insertion of tshag "‡ºã" on spacebar press
    inputBox.addEventListener('keydown', function(event) {
        if (event.key === ' ') {
            event.preventDefault();
            const cursorPos = inputBox.selectionStart;
            const text = inputBox.value;
            const prevChar = text[cursorPos - 1];

            if (prevChar !== '‡ºç') {
                inputBox.value = text.slice(0, cursorPos) + '‡ºã' + text.slice(cursorPos);
                inputBox.selectionEnd = cursorPos + 1;
            } else {
                inputBox.value = text.slice(0, cursorPos) + ' ' + text.slice(cursorPos);
                inputBox.selectionEnd = cursorPos + 1;
            }
        }
    });

    // Fetch predictions from backend
    function fetchPredictions() {
        const text = inputBox.value.trim();
        if (text === "") {
            suggestionsDiv.innerHTML = "";
            loadingDiv.style.display = 'none';
            return;
        }

        loadingDiv.style.display = 'block';
        fetch(`/predict_ajax?text=${encodeURIComponent(text)}`)
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                suggestionsDiv.innerHTML = "";

                if (data.predictions && data.predictions.length > 0) {
                    data.predictions.forEach((pred, index) => {
                        const btn = document.createElement("div");
                        btn.className = "suggestion";
                        btn.innerText = pred;
                        btn.title = `Suggestion ${index + 1}`;

                        // New robust click handler
                        btn.onclick = () => {
                            const fullText = inputBox.value;
                            const lastTshagIndex = fullText.lastIndexOf('‡ºã');
                            const lastShedIndex = fullText.lastIndexOf('‡ºç');
                            const sepIndex = Math.max(lastTshagIndex, lastShedIndex);
                            const sepChar = sepIndex === -1 ? null : fullText[sepIndex];

                            let newText;
                            // If there's a shed at the very end, user likely finished a sentence
                            if (sepChar === '‡ºç' && sepIndex === fullText.length - 1) {
                                // Append suggestion after the trailing shed (start new sentence)
                                newText = fullText + (pred === '‡ºç' ? pred : pred + '‡ºã');
                            } else {
                                // Replace everything after the last separator (or whole text if none)
                                const prefix = sepIndex === -1 ? '' : fullText.substring(0, sepIndex + 1);
                                newText = (pred === '‡ºç') ? (prefix + pred) : (prefix + pred + '‡ºã');
                            }

                            // Normalize: remove any accidental duplicate Tshags (optional)
                            // e.g., if prefix already ends with '‡ºã' and pred also results in an extra '‡ºã'
                            // but the above logic shouldn't create duplicates; keep this safe-guard minimal:
                            newText = newText.replace(/‡ºã{2,}/g, '‡ºã');

                            inputBox.value = newText;
                            // Move caret to end
                            inputBox.selectionStart = inputBox.selectionEnd = inputBox.value.length;
                            inputBox.focus();
                            fetchPredictions();
                        };

                        suggestionsDiv.appendChild(btn);
                    });
                } else {
                    suggestionsDiv.innerHTML = '<div class="no-suggestions">üì≠ No suggestions available</div>';
                }
            })
            .catch(err => {
                loadingDiv.style.display = 'none';
                console.error("Error:", err);
                suggestionsDiv.innerHTML = '<div class="error-message">‚ùå Error fetching suggestions</div>';
            });
    }

    // Update predictions as user types with debounce
    let debounceTimer;
    inputBox.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fetchPredictions, 300);
    });
</script>

</body>
</html>
